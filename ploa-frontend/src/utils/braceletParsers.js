// 팔찌 관련 툴팁 파싱 유틸리티 함수들

// 팔찌 효과별 정확한 등급 매핑 테이블 (팔찌 옵션.txt 기반)
const EFFECT_GRADE_MAP = {
  '유물': {
    // 치명타 적중률 + 보너스 (하, 중, 상)
    '치명타 적중률이 2.6% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '하',
    '치명타 적중률이 3.4% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '중',
    '치명타 적중률이 4.2% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '상',
    
    // 치명타 피해 + 보너스 (하, 중, 상)
    '치명타 피해가 5.2% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '하',
    '치명타 피해가 6.8% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '중',
    '치명타 피해가 8.4% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '상',
    
    // 무력화 피해 (하, 중, 상)
    '적에게 주는 피해가 1.5% 증가하며, 무력화 상태의 적에게 주는 피해가 3.5% 증가한다.': '하',
    '적에게 주는 피해가 2.0% 증가하며, 무력화 상태의 적에게 주는 피해가 4.0% 증가한다.': '중',
    '적에게 주는 피해가 2.5% 증가하며, 무력화 상태의 적에게 주는 피해가 4.5% 증가한다.': '상',
    
    // 악마 피해 (하, 중, 상)
    '추가 피해가 2.0% 증가한다. 악마 및 대악마 계열 피해량이 2.5% 증가한다.': '하',
    '추가 피해가 2.5% 증가한다. 악마 및 대악마 계열 피해량이 2.5% 증가한다.': '중',
    '추가 피해가 3.0% 증가한다. 악마 및 대악마 계열 피해량이 2.5% 증가한다.': '상',
    
    // 쿨감 딜증 (하, 중, 상)
    '스킬의 재사용 대기 시간이 2% 증가하지만, 적에게 주는 피해가 4.0% 증가한다.': '하',
    '스킬의 재사용 대기 시간이 2% 증가하지만, 적에게 주는 피해가 4.5% 증가한다.': '중',
    '스킬의 재사용 대기 시간이 2% 증가하지만, 적에게 주는 피해가 5.0% 증가한다.': '상',
    
    // 방감 딜증 (하, 중, 상)
    '적에게 공격 적중 시 8초 동안 대상의 방어력을 1.5% 감소시킨다. 아군 공격력 강화 효과가 1.5% 증가한다.': '하',
    '적에게 공격 적중 시 8초 동안 대상의 방어력을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '중',
    '적에게 공격 적중 시 8초 동안 대상의 방어력을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '상',
    // 방감 딜증 - 몬스터에게 버전 (하, 중, 상)
    '몬스터에게 공격 적중 시 8초 동안 대상의 방어력을 1.5% 감소시킨다. 아군 공격력 강화 효과가 1.5% 증가한다.': '하',
    '몬스터에게 공격 적중 시 8초 동안 대상의 방어력을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '중',
    '몬스터에게 공격 적중 시 8초 동안 대상의 방어력을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '상',
    
    // 치저감 딜증 (하, 중, 상)
    '적에게 공격 적중 시 8초 동안 대상의 치명타 저항을 1.5% 감소시킨다. 아군 공격력 강화 효과가 1.5% 증가한다.': '하',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 저항을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '중',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 저항을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '상',
    // 치저감 딜증 - 몬스터에게 버전 (하, 중, 상)
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 저항을 1.5% 감소시킨다. 아군 공격력 강화 효과가 1.5% 증가한다.': '하',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 저항을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '중',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 저항을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '상',
    
    // 보호막 딜증 (하, 중, 상)
    '파티 효과로 보호 효과가 적용된 대상이 5초 동안 적에게 주는 피해가 0.7% 증가한다. 아군 공격력 강화 효과가 1.5% 증가한다.': '하',
    '파티 효과로 보호 효과가 적용된 대상이 5초 동안 적에게 주는 피해가 0.9% 증가한다. 아군 공격력 강화 효과가 2.0% 증가한다.': '중',
    '파티 효과로 보호 효과가 적용된 대상이 5초 동안 적에게 주는 피해가 1.1% 증가한다. 아군 공격력 강화 효과가 2.5% 증가한다.': '상',
    
    // 치피저감 딜증 (하, 중, 상)
    '적에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 3.0% 감소시킨다. 아군 공격력 강화 효과가 1.5% 증가한다.': '하',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 3.6% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '중',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 4.2% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '상',
    // 치피저감 딜증 - 몬스터에게 버전 (하, 중, 상)
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 3.0% 감소시킨다. 아군 공격력 강화 효과가 1.5% 증가한다.': '하',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 3.6% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '중',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 4.2% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '상',
    
    // 광분 (하, 중, 상) - 공백 변형 버전 추가
    '공격 적중 시 매 초 마다 10초 동안 무기 공격력이 1000, 공격 및 이동 속도가 1% 증가한다.(최대 6중첩)': '하',
    '공격 적중 시 매 초 마다 10초 동안 무기 공격력이 1160, 공격 및 이동 속도가 1% 증가한다.(최대 6중첩)': '중',
    '공격 적중 시 매 초 마다 10초 동안 무기 공격력이 1320, 공격 및 이동 속도가 1% 증가한다.(최대 6중첩)': '상',
    // 공백 없는 "매 초마다" 버전
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1000, 공격 및 이동 속도가 1% 증가한다.(최대 6중첩)': '하',
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1160, 공격 및 이동 속도가 1% 증가한다.(최대 6중첩)': '중',
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1320, 공격 및 이동 속도가 1% 증가한다.(최대 6중첩)': '상',
    // 괄호 앞 공백 있는 버전
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1000, 공격 및 이동 속도가 1% 증가한다. (최대 6중첩)': '하',
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1160, 공격 및 이동 속도가 1% 증가한다. (최대 6중첩)': '중',
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1320, 공격 및 이동 속도가 1% 증가한다. (최대 6중첩)': '상',
    
    // 열정 (하, 중, 상)
    '무기 공격력이 6300 증가한다. 자신의 생명력이 50% 이상일 경우 적에게 공격 적중 시 5초 동안 무기 공격력이 1800 증가한다.': '하',
    '무기 공격력이 7200 증가한다. 자신의 생명력이 50% 이상일 경우 적에게 공격 적중 시 5초 동안 무기 공격력이 2000 증가한다.': '중',
    '무기 공격력이 8100 증가한다. 자신의 생명력이 50% 이상일 경우 적에게 공격 적중 시 5초 동안 무기 공격력이 2200 증가한다.': '상',
    
    // 예열 (하, 중, 상)
    '무기 공격력이 6000 증가한다. 공격 적중 시 30초 마다 120초 동안 무기 공격력이 120 증가한다. (최대 30중첩)': '하',
    '무기 공격력이 6900 증가한다. 공격 적중 시 30초 마다 120초 동안 무기 공격력이 130 증가한다. (최대 30중첩)': '중',
    '무기 공격력이 7800 증가한다. 공격 적중 시 30초 마다 120초 동안 무기 공격력이 140 증가한다. (최대 30중첩)': '상',
    
    // 기본 피해 (하, 중, 상)
    '적에게 주는 피해가 1.5% 증가한다.': '하',
    '적에게 주는 피해가 2.0% 증가한다.': '중',
    '적에게 주는 피해가 2% 증가한다.': '중', // 소수점 없는 버전
    '적에게 주는 피해가 2.5% 증가한다.': '상',
    
    // 추가 피해만 (하, 중, 상)
    '추가 피해 +2.5%': '하',
    '추가 피해 +3.0%': '중',
    '추가 피해 +3%': '중', // 소수점 없는 버전
    '추가 피해 +3.5%': '상',
    
    // 백어택 (하, 중, 상)
    '백어택 스킬이 적에게 주는 피해가 2.0% 증가한다.': '하',
    '백어택 스킬이 적에게 주는 피해가 2% 증가한다.': '하', // 소수점 없는 버전
    '백어택 스킬이 적에게 주는 피해가 2.5% 증가한다.': '중',
    '백어택 스킬이 적에게 주는 피해가 3.0% 증가한다.': '상',
    '백어택 스킬이 적에게 주는 피해가 3% 증가한다.': '상', // 소수점 없는 버전
    
    // 헤드어택 (하, 중, 상)
    '헤드어택 스킬이 적에게 주는 피해가 2.0% 증가한다.': '하',
    '헤드어택 스킬이 적에게 주는 피해가 2.5% 증가한다.': '중',
    '헤드어택 스킬이 적에게 주는 피해가 3.0% 증가한다.': '상',
    
    // 무방향 (하, 중, 상)
    '방향성 공격이 아닌 스킬이 적에게 주는 피해가 2.0% 증가한다.': '하',
    '방향성 공격이 아닌 스킬이 적에게 주는 피해가 2.5% 증가한다.': '중',
    '방향성 공격이 아닌 스킬이 적에게 주는 피해가 3.0% 증가한다.': '상',
    
    // 회복 효과 (하, 중, 상)
    '파티원 보호 및 회복 효과가 2.0% 증가한다.': '하',
    '파티원 보호 및 회복 효과가 2.5% 증가한다.': '중',
    '파티원 보호 및 회복 효과가 3.0% 증가한다.': '상',
    
    // 아공강 (하, 중, 상)
    '아군 공격력 강화 효과 +3.0%': '하',
    '아군 공격력 강화 효과 +3%': '하', // 소수점 없는 버전
    '아군 공격력 강화 효과 +4.0%': '중',
    '아군 공격력 강화 효과 +4%': '중', // 소수점 없는 버전
    '아군 공격력 강화 효과 +5.0%': '상',
    '아군 공격력 강화 효과 +5%': '상', // 소수점 없는 버전
    '아군 공격력 강화 효과 +6.0%': '상', // 추가 소수점 버전
    '아군 공격력 강화 효과 +6%': '상', // 추가 정수 버전
    '아군 공격력 강화 효과 +6.00%': '상', // 사용자 제공 예시
    
    // 아피강 (하, 중, 상)
    '아군 피해량 강화 효과 +4.5%': '하',
    '아군 피해량 강화 효과 +6.0%': '중',
    '아군 피해량 강화 효과 +6%': '중', // 소수점 없는 버전
    '아군 피해량 강화 효과 +7.5%': '상',
    '아군 피해량 강화 효과 +9.0%': '상', // 추가 소수점 버전
    '아군 피해량 강화 효과 +9%': '상', // 추가 정수 버전
    '아군 피해량 강화 효과 +9.00%': '상', // 추가 소수점 버전
    
    // 치명타 적중률만 (하, 중, 상)
    '치명타 적중률 +2.6%': '하',
    '치명타 적중률 +3.4%': '중',
    '치명타 적중률 +4.2%': '상',
    
    // 치명타 피해만 (하, 중, 상)
    '치명타 피해 +5.2%': '하',
    '치명타 피해 +6.8%': '중',
    '치명타 피해 +8.4%': '상',
    
    // 무기 공격력만 (하, 중, 상)
    '무기 공격력 +6300': '하',
    '무기 공격력 +7200': '중',
    '무기 공격력 +8100': '상'
  },
  
  '고대': {
    // 치명타 적중률 + 보너스 (하, 중, 상)
    '치명타 적중률이 3.4% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '하',
    '치명타 적중률이 4.2% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '중',
    '치명타 적중률이 5.0% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '상',
    '치명타 적중률이 5% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '상', // 5% (소수점 없는 버전)
    
    // 치명타 피해 + 보너스 (하, 중, 상)
    '치명타 피해가 6.8% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '하',
    '치명타 피해가 8.4% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '중',
    '치명타 피해가 10.0% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '상',
    '치명타 피해가 10% 증가한다. 공격이 치명타로 적중 시 적에게 주는 피해가 1.5% 증가한다.': '상', // 10% (소수점 없는 버전)
    
    // 무력화 피해 (하, 중, 상)
    '적에게 주는 피해가 2.0% 증가하며, 무력화 상태의 적에게 주는 피해가 4.0% 증가한다.': '하',
    '적에게 주는 피해가 2% 증가하며, 무력화 상태의 적에게 주는 피해가 4% 증가한다.': '하', // 소수점 없는 버전
    '적에게 주는 피해가 2.5% 증가하며, 무력화 상태의 적에게 주는 피해가 4.5% 증가한다.': '중',
    '적에게 주는 피해가 3.0% 증가하며, 무력화 상태의 적에게 주는 피해가 5.0% 증가한다.': '상',
    '적에게 주는 피해가 3% 증가하며, 무력화 상태의 적에게 주는 피해가 5% 증가한다.': '상', // 소수점 없는 버전
    
    // 악마 피해 (하, 중, 상)
    '추가 피해가 2.5% 증가한다. 악마 및 대악마 계열 피해량이 2.5% 증가한다.': '하',
    '추가 피해가 3.0% 증가한다. 악마 및 대악마 계열 피해량이 2.5% 증가한다.': '중',
    '추가 피해가 3% 증가한다. 악마 및 대악마 계열 피해량이 2.5% 증가한다.': '중', // 소수점 없는 버전
    '추가 피해가 3.5% 증가한다. 악마 및 대악마 계열 피해량이 2.5% 증가한다.': '상',
    
    // 쿨감 딜증 (하, 중, 상)
    '스킬의 재사용 대기 시간이 2% 증가하지만, 적에게 주는 피해가 4.5% 증가한다.': '하',
    '스킬의 재사용 대기 시간이 2% 증가하지만, 적에게 주는 피해가 5.0% 증가한다.': '중',
    '스킬의 재사용 대기 시간이 2% 증가하지만, 적에게 주는 피해가 5% 증가한다.': '중', // 소수점 없는 버전
    '스킬의 재사용 대기 시간이 2% 증가하지만, 적에게 주는 피해가 5.5% 증가한다.': '상',
    
    // 방감 딜증 (하, 중, 상) - "적에게" 버전
    '적에게 공격 적중 시 8초 동안 대상의 방어력을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '하',
    '적에게 공격 적중 시 8초 동안 대상의 방어력을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '중',
    '적에게 공격 적중 시 8초 동안 대상의 방어력을 2.5% 감소시킨다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    
    // 방감 딜증 (하, 중, 상) - "몬스터에게" 버전 (실제 API 응답 형태)
    '몬스터에게 공격 적중 시 8초 동안 대상의 방어력을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2% 증가한다.': '하',
    '몬스터에게 공격 적중 시 8초 동안 대상의 방어력을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '중',
    '몬스터에게 공격 적중 시 8초 동안 대상의 방어력을 2.5% 감소시킨다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    
    // 치저감 딜증 (하, 중, 상) - "적에게" 버전
    '적에게 공격 적중 시 8초 동안 대상의 치명타 저항을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '하',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 저항을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '중',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 저항을 2.5% 감소시킨다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    
    // 치저감 딜증 (하, 중, 상) - "몬스터에게" 버전 (실제 API 응답 형태)
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 저항을 1.8% 감소시킨다. 아군 공격력 강화 효과가 2% 증가한다.': '하',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 저항을 2.1% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '중',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 저항을 2.5% 감소시킨다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    
    // 보호막 딜증 (하, 중, 상)
    '파티 효과로 보호 효과가 적용된 대상이 5초 동안 적에게 주는 피해가 0.9% 증가한다. 아군 공격력 강화 효과가 2.0% 증가한다.': '하',
    '파티 효과로 보호 효과가 적용된 대상이 5초 동안 적에게 주는 피해가 1.1% 증가한다. 아군 공격력 강화 효과가 2.5% 증가한다.': '중',
    '파티 효과로 보호 효과가 적용된 대상이 5초 동안 적에게 주는 피해가 1.3% 증가한다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    // 보호막 딜증 - 텍스트 변형 버전 (보호 효과 상세 설명 포함)
    '파티 효과로 보호 효과(보호막, 생명력 회복, 받는 피해 감소)가 적용된 대상이 5초 동안 적에게 주는 피해가 1.3% 증가한다. 아군 공격력 강화 효과가 3% 증가한다.': '상',
    '파티 효과로 보호 효과(보호막, 생명력 회복, 받는 피해 감소)가 적용된 대상이 5초 동안 적에게 주는 피해가 1.3% 증가한다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    
    // 치피저감 딜증 (하, 중, 상) - "적에게" 버전
    '적에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 3.6% 감소시킨다. 아군 공격력 강화 효과가 2.0% 증가한다.': '하',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 4.2% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '중',
    '적에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 4.8% 감소시킨다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    
    // 치피저감 딜증 (하, 중, 상) - "몬스터에게" 버전 (실제 API 응답 형태)
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 3.6% 감소시킨다. 아군 공격력 강화 효과가 2% 증가한다.': '하',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 4.2% 감소시킨다. 아군 공격력 강화 효과가 2.5% 증가한다.': '중',
    '몬스터에게 공격 적중 시 8초 동안 대상의 치명타 피해 저항을 4.8% 감소시킨다. 아군 공격력 강화 효과가 3.0% 증가한다.': '상',
    
    // 광분 (하, 중, 상) - 공백 변형 버전 추가
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1160, 공격 및 이동 속도가 1% 증가한다. (최대 6중첩)': '하',
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1320, 공격 및 이동 속도가 1% 증가한다. (최대 6중첩)': '중',
    '공격 적중 시 매 초마다 10초 동안 무기 공격력이 1480, 공격 및 이동 속도가 1% 증가한다. (최대 6중첩)': '상',
    
    // 열정 (하, 중, 상)
    '무기 공격력이 7200 증가한다. 자신의 생명력이 50% 이상일 경우 적에게 공격 적중 시 5초 동안 무기 공격력이 2000 증가한다.': '하',
    '무기 공격력이 8100 증가한다. 자신의 생명력이 50% 이상일 경우 적에게 공격 적중 시 5초 동안 무기 공격력이 2200 증가한다.': '중',
    '무기 공격력이 9000 증가한다. 자신의 생명력이 50% 이상일 경우 적에게 공격 적중 시 5초 동안 무기 공격력이 2400 증가한다.': '상',
    
    // 예열 (하, 중, 상)
    '무기 공격력이 6900 증가한다. 공격 적중 시 30초 마다 120초 동안 무기 공격력이 130 증가한다. (최대 30중첩)': '하',
    '무기 공격력이 7800 증가한다. 공격 적중 시 30초 마다 120초 동안 무기 공격력이 140 증가한다. (최대 30중첩)': '중',
    '무기 공격력이 8700 증가한다. 공격 적중 시 30초 마다 120초 동안 무기 공격력이 150 증가한다. (최대 30중첩)': '상',
    
    // 기본 피해 (하, 중, 상)
    '적에게 주는 피해가 2.0% 증가한다.': '하',
    '적에게 주는 피해가 2% 증가한다.': '하', // 소수점 없는 버전
    '적에게 주는 피해가 2.5% 증가한다.': '중',
    '적에게 주는 피해가 3.0% 증가한다.': '상',
    '적에게 주는 피해가 3% 증가한다.': '상', // 소수점 없는 버전
    
    // 추가 피해만 (하, 중, 상)
    '추가 피해 +3.0%': '하',
    '추가 피해 +3%': '하', // 소수점 없는 버전
    '추가 피해 +3.5%': '중',
    '추가 피해 +4.0%': '상',
    '추가 피해 +4%': '상', // 소수점 없는 버전
    
    // 백어택 (하, 중, 상)
    '백어택 스킬이 적에게 주는 피해가 2.5% 증가한다.': '하',
    '백어택 스킬이 적에게 주는 피해가 3.0% 증가한다.': '중',
    '백어택 스킬이 적에게 주는 피해가 3% 증가한다.': '중', // 소수점 없는 버전
    '백어택 스킬이 적에게 주는 피해가 3.5% 증가한다.': '상',
    
    // 헤드어택 (하, 중, 상)
    '헤드어택 스킬이 적에게 주는 피해가 2.5% 증가한다.': '하',
    '헤드어택 스킬이 적에게 주는 피해가 3.0% 증가한다.': '중',
    '헤드어택 스킬이 적에게 주는 피해가 3% 증가한다.': '중', // 소수점 없는 버전
    '헤드어택 스킬이 적에게 주는 피해가 3.5% 증가한다.': '상',
    
    // 무방향 (하, 중, 상)
    '방향성 공격이 아닌 스킬이 적에게 주는 피해가 2.5% 증가한다.': '하',
    '방향성 공격이 아닌 스킬이 적에게 주는 피해가 3.0% 증가한다.': '중',
    '방향성 공격이 아닌 스킬이 적에게 주는 피해가 3% 증가한다.': '중', // 소수점 없는 버전
    '방향성 공격이 아닌 스킬이 적에게 주는 피해가 3.5% 증가한다.': '상',
    
    // 회복 효과 (하, 중, 상)
    '파티원 보호 및 회복 효과가 2.5% 증가한다.': '하',
    '파티원 보호 및 회복 효과가 3.0% 증가한다.': '중',
    '파티원 보호 및 회복 효과가 3.5% 증가한다.': '상',
    
    // 아공강 (하, 중, 상)
    '아군 공격력 강화 효과 +4.0%': '하',
    '아군 공격력 강화 효과 +4%': '하', // 소수점 없는 버전
    '아군 공격력 강화 효과 +5.0%': '중',
    '아군 공격력 강화 효과 +5%': '중', // 소수점 없는 버전
    '아군 공격력 강화 효과 +6.0%': '상',
    '아군 공격력 강화 효과 +6%': '상', // 소수점 없는 버전
    '아군 공격력 강화 효과 +6.00%': '상', // 추가 소수점 버전
    
    // 아피강 (하, 중, 상)
    '아군 피해량 강화 효과 +6.0%': '하',
    '아군 피해량 강화 효과 +6%': '하', // 소수점 없는 버전
    '아군 피해량 강화 효과 +6.00%': '하', // 추가 소수점 버전
    '아군 피해량 강화 효과 +7.5%': '중',
    '아군 피해량 강화 효과 +9.0%': '상',
    '아군 피해량 강화 효과 +9%': '상', // 소수점 없는 버전
    '아군 피해량 강화 효과 +9.00%': '상', // 추가 소수점 버전
    
    // 치명타 적중률만 (하, 중, 상)
    '치명타 적중률 +3.4%': '하',
    '치명타 적중률 +4.2%': '중',
    '치명타 적중률 +5.0%': '상',
    
    // 치명타 피해만 (하, 중, 상)
    '치명타 피해 +6.8%': '하',
    '치명타 피해 +8.4%': '중',
    '치명타 피해 +10.0%': '상',
    
    // 무기 공격력만 (하, 중, 상)
    '무기 공격력 +7200': '하',
    '무기 공격력 +8100': '중',
    '무기 공격력 +9000': '상'
  }
};

/**
 * 텍스트 정규화 함수 (공백, 특수문자 통일)
 */
const normalizeText = (text) => {
  return text
    .replace(/\s+/g, ' ')  // 연속 공백을 하나로
    .replace(/[\u00A0\u2000-\u200B\u2028\u2029\u3000]/g, ' ')  // 다양한 공백 문자 통일
    .trim();
};

/**
 * 효과 텍스트와 유연하게 매칭하여 등급 분류
 * @param {string} effectText - 팔찌 효과 텍스트
 * @param {string} itemGrade - 팔찌 등급 ('유물' 또는 '고대')
 * @returns {string|null} - '하', '중', '상' 또는 null
 */
const getEffectGradeByText = (effectText, itemGrade = '유물') => {
  const gradeMap = EFFECT_GRADE_MAP[itemGrade];
  if (!gradeMap) return null;
  
  // 1차: 정확한 텍스트 매칭
  let exactMatch = gradeMap[effectText];
  if (exactMatch) {
    return exactMatch;
  }
  
  // 2차: 정규화된 텍스트로 매칭
  const normalizedInput = normalizeText(effectText);
  for (const [mappedText, grade] of Object.entries(gradeMap)) {
    if (normalizeText(mappedText) === normalizedInput) {
      return grade;
    }
  }
  
  // 3차: 핵심 키워드 기반 매칭 (숫자값으로 구분) - 정확한 숫자 매칭 우선
  const percentMatches = effectText.match(/(\d+\.?\d*)%/g);
  const numberMatches = effectText.match(/(\d+)/g);
  
  if (percentMatches || numberMatches) {
    // 먼저 정확한 숫자값이 매칭되는 항목들을 찾기
    const candidatesWithSamePattern = [];
    
    for (const [mappedText, grade] of Object.entries(gradeMap)) {
      // 핵심 키워드 매칭 (숫자 제외한 텍스트 비교)
      const inputWithoutNumbers = effectText.replace(/\d+\.?\d*/g, 'X');
      const mappedWithoutNumbers = mappedText.replace(/\d+\.?\d*/g, 'X');
      
      if (normalizeText(inputWithoutNumbers) === normalizeText(mappedWithoutNumbers)) {
        candidatesWithSamePattern.push({ mappedText, grade });
      }
    }
    
    // 같은 패턴을 가진 후보들 중에서 정확한 숫자값 매칭 찾기
    if (candidatesWithSamePattern.length > 0) {
      // 입력 텍스트에서 숫자값들 추출
      const inputNumbers = effectText.match(/\d+\.?\d*/g) || [];
      
      for (const candidate of candidatesWithSamePattern) {
        const candidateNumbers = candidate.mappedText.match(/\d+\.?\d*/g) || [];
        
        // 모든 숫자가 정확히 일치하는지 확인
        if (inputNumbers.length === candidateNumbers.length) {
          let allNumbersMatch = true;
          for (let i = 0; i < inputNumbers.length; i++) {
            if (parseFloat(inputNumbers[i]) !== parseFloat(candidateNumbers[i])) {
              allNumbersMatch = false;
              break;
            }
          }
          
          if (allNumbersMatch) {
            return candidate.grade;
          }
        }
      }
      
      // 정확한 숫자 매칭이 없으면 첫 번째 후보 반환 (기존 동작)
      return candidatesWithSamePattern[0].grade;
    }
  }
  
  return null;
};

/**
 * 팔찌 특수 효과 분류 및 필터링 함수 (간소화된 버전)
 * @param {string} effectText - 팔찌 효과 텍스트
 * @param {string} itemGrade - 팔찌 등급 ('유물' 또는 '고대')
 * @returns {object} - {category, grade, shouldShow, isBaseStat}
 */
export const classifyBraceletEffect = (effectText, itemGrade = '유물') => {
  if (!effectText) return { category: 'unknown', grade: null, shouldShow: false, isBaseStat: false };

  // 치명, 특화, 신속 스탯만 기본 스탯으로 분류 (실제 스탯 수치가 있는 경우만)
  const baseStatPatterns = [
    /^치명\s*\+?\d+$/,  // "치명 +1234" 또는 "치명1234" 형태만
    /^특화\s*\+?\d+$/,  // "특화 +5678" 또는 "특화5678" 형태만
    /^신속\s*\+?\d+$/   // "신속 +9012" 또는 "신속9012" 형태만
  ];

  // 숨길 스탯들 (제압, 인내, 숙련) 및 불필요한 특수 효과들
  const hiddenStatPatterns = [
    /제압/,
    /인내/,
    /숙련/,
    /힘/,
    /민첩/,
    /지능/,
    /체력/,
    // 공격 및 이동 속도
    /공격 및 이동 속도가.*증가한다/,
    // 시드 등급 관련
    /시드 등급 이하 몬스터에게.*피해/,
    // 방어력 관련
    /물리 방어력.*\+\d+/,
    /마법 방어력.*\+\d+/,
    // 생명력 관련  
    /최대 생명력.*\+\d+/,
    /전투 중 생명력 회복량/,
    // 전투자원
    /전투자원 자연 회복량/,
    // 이동기 및 기상기
    /이동기 및 기상기 재사용 대기 시간/,
    // 경직 면역
    /경직 및 피격 이상에 면역/,
    /해당 효과는 1회 피격 시 사라진다/
  ];

  // 기본 스탯 체크
  for (const pattern of baseStatPatterns) {
    if (pattern.test(effectText)) {
      return { category: 'baseStat', grade: null, shouldShow: true, isBaseStat: true };
    }
  }

  // 광분 효과 먼저 체크 (숨김 처리보다 우선)
  if ((effectText.includes('공격 적중 시 매 초 마다') || effectText.includes('공격 적중 시 매 초마다')) && 
      effectText.includes('무기 공격력이') && 
      (effectText.includes('최대 6중첩') || effectText.includes('(최대 6중첩)'))) {
    const grade = getEffectGradeByText(effectText, itemGrade);
    return { 
      category: 'special', 
      grade, 
      shouldShow: true, 
      isBaseStat: false 
    };
  }

  // 숨길 스탯 체크
  for (const pattern of hiddenStatPatterns) {
    if (pattern.test(effectText)) {
      return { category: 'hidden', grade: null, shouldShow: false, isBaseStat: false };
    }
  }

  // 텍스트 매칭 기반으로 등급 분류
  const grade = getEffectGradeByText(effectText, itemGrade);
  
  return { 
    category: 'special', 
    grade, 
    shouldShow: true, 
    isBaseStat: false 
  };
};

/**
 * 팔찌 효과 추출 및 분류 함수 (간소화된 원문 유지 방식)
 * @param {string} tooltip - 팔찌 툴팁 JSON 문자열
 * @param {string} itemGrade - 팔찌 등급 ('유물' 또는 '고대')
 * @returns {object} - {baseStats: [], specialEffects: []}
 */
export const getBraceletEffects = (tooltip, itemGrade = '유물') => {
  if (!tooltip) return { baseStats: [], specialEffects: [] };
  
  const baseStats = [];
  const specialEffects = [];
  
  try {
    const tooltipData = JSON.parse(tooltip);
    
    // 모든 Element를 확인하여 팔찌 효과 찾기
    for (let i = 0; i <= 30; i++) {
      const elementKey = `Element_${String(i).padStart(3, '0')}`;
      const element = tooltipData[elementKey];
      
      if (element && element.type === 'ItemPartBox' && element.value) {
        // Element_000에서 "팔찌 효과" 체크
        if (element.value.Element_000 && element.value.Element_000.includes('팔찌 효과')) {
          // Element_001에 팔찌 효과 내용이 있음
          const effectContent = element.value.Element_001;
          if (effectContent) {
            
            // HTML 태그 제거하고 원문 그대로 유지 (BR은 줄바꿈으로 처리)
            const cleanText = effectContent
              .replace(/<img[^>]*>/gi, '')
              .replace(/<\/img>/gi, '')
              .replace(/<FONT[^>]*>/gi, '')
              .replace(/<\/FONT>/gi, '')
              .replace(/<font[^>]*>/gi, '')
              .replace(/<\/font>/gi, '')
              .replace(/<br>/gi, '\n')
              .replace(/<BR>/gi, '\n')
              // 불필요한 파티 제한 텍스트 및 추가 설명 제거
              .replace(/해당 효과는 한 파티 당 하나만 적용된다\.\s*/g, '')
              .replace(/\s*해당 효과는 한 파티 당 하나만 적용된다\./g, '')
              .replace(/해당 효과는 한 파티 당 하나만 적용되며,\s*/g, '')
              .replace(/\s*해당 효과는 한 파티 당 하나만 적용되며,/g, '')
              .replace(/지속 시간이 없는 보호 효과에는 적용되지 않는다\.\s*/g, '')
              .replace(/\s*지속 시간이 없는 보호 효과에는 적용되지 않는다\./g, '')
              .replace(/각성기는 적용되지 않는다\.\s*/g, '')
              .replace(/\s*각성기는 적용되지 않는다\./g, '')
              .trim();
            
            
            // 줄바꿈으로 개별 효과 분리하고 불필요한 설명 문장 제거
            const effectLines = cleanText.split('\n')
              .map(line => line.trim())
              .filter(line => line.length > 0)
              .filter(line => {
                // 불필요한 설명 문장들 필터링
                if (line.includes('해당 효과는 한 파티 당 하나만 적용된다')) return false;
                if (line.includes('해당 효과는 한 파티 당 하나만 적용되며')) return false;
                if (line.includes('지속 시간이 없는 보호 효과에는 적용되지 않는다')) return false;
                if (line.includes('각성기는 적용되지 않는다')) return false;
                if (line.includes('해당 효과는 1회 피격 시 사라진다')) return false;
                
                // "재사용 대기 시간"이 포함된 줄은 대부분 설명이지만, 쿨감 딜증 효과는 예외
                if (line.includes('재사용 대기 시간') && !line.includes('스킬의 재사용 대기 시간이')) {
                  return false;
                }
                
                return true;
              });
            
            
            // 각 줄을 개별 효과로 처리
            for (let j = 0; j < effectLines.length; j++) {
              const currentLine = effectLines[j];
              let effectText = currentLine;
              
              
              // 이중 옵션 감지: 현재 줄과 다음 줄이 연관된 효과인지 확인
              if (j < effectLines.length - 1) {
                const nextLine = effectLines[j + 1];
                
                // 먼저 다음 줄이 단일 효과인지 확인 (단일 효과는 이중 옵션에 포함되지 않음)
                const isNextLineSingleEffect = 
                  // "아군 공격력 강화 효과 +숫자%" 형태 (단일 효과) - 소수점 지원
                  /^아군 공격력 강화 효과 \+\d+(?:\.\d+)?%$/.test(nextLine.trim()) ||
                  // "아군 피해량 강화 효과 +숫자%" 형태 (단일 효과) - 소수점 지원
                  /^아군 피해량 강화 효과 \+\d+(?:\.\d+)?%$/.test(nextLine.trim()) ||
                  // "치명타 적중률 +숫자%" 형태 (단일 효과)
                  /^치명타 적중률 \+\d+\.?\d*%$/.test(nextLine.trim()) ||
                  // "치명타 피해 +숫자%" 형태 (단일 효과)
                  /^치명타 피해 \+\d+\.?\d*%$/.test(nextLine.trim()) ||
                  // "추가 피해 +숫자%" 형태 (단일 효과)
                  /^추가 피해 \+\d+\.?\d*%$/.test(nextLine.trim()) ||
                  // "무기 공격력 +숫자" 형태 (단일 효과)
                  /^무기 공격력 \+\d+$/.test(nextLine.trim()) ||
                  // "적에게 주는 피해가 숫자% 증가한다." 형태 (단일 효과)
                  /^적에게 주는 피해가 \d+\.?\d*% 증가한다\.$/.test(nextLine.trim());
                
                if (isNextLineSingleEffect) {
                  effectText = currentLine;
                } else {
                  // 이중 옵션 패턴 확인 - 더 정확한 매칭
                  let isDualEffect = false;
                  
                  // 1. 치명타 적중률 + 치명타 적중 시 피해 증가
                  if (currentLine.includes('치명타 적중률이') && nextLine.includes('공격이 치명타로 적중 시')) {
                    isDualEffect = true;
                  }
                  // 2. 치명타 피해 + 치명타 적중 시 피해 증가  
                  else if (currentLine.includes('치명타 피해가') && nextLine.includes('공격이 치명타로 적중 시')) {
                    isDualEffect = true;
                  }
                  // 3. 추가 피해 + 악마 계열 피해
                  else if (currentLine.includes('추가 피해가') && nextLine.includes('악마 및 대악마 계열')) {
                    isDualEffect = true;
                  }
                  // 4. 무력화 피해 (한 줄에 모든 내용이 있음)
                  else if (currentLine.includes('무력화 상태의 적에게 주는 피해가')) {
                    // 이미 한 줄에 모든 내용이 있으므로 이중 옵션이 아님
                    isDualEffect = false;
                  }
                  // 4-1. 광분 효과 (한 줄에 모든 내용이 있음)
                  else if (currentLine.includes('공격 적중 시 매 초 마다') && currentLine.includes('무기 공격력이') && currentLine.includes('공격 및 이동 속도가')) {
                    // 이미 한 줄에 모든 내용이 있으므로 이중 옵션이 아님
                    isDualEffect = false;
                  }
                  // 5. 열정 효과 (무기 공격력 기본 + 생명력 50% 이상 시 추가 효과)
                  else if (currentLine.includes('무기 공격력이') && currentLine.includes('증가한다.') && 
                           nextLine.includes('자신의 생명력이 50% 이상일 경우')) {
                    isDualEffect = true;
                  }
                  // 6. 예열 효과 (무기 공격력 기본 + 30초마다 중첩 효과)
                  else if (currentLine.includes('무기 공격력이') && currentLine.includes('증가한다.') && 
                           nextLine.includes('공격 적중 시 30초 마다')) {
                    isDualEffect = true;
                  }
                  // 7. 아군 강화 효과가 별도 줄에 있는 경우 (방감 딜증, 치저감 딜증, 보호막 딜증, 치피저감 딜증)
                  else if (nextLine.includes('아군 공격력 강화 효과가') || 
                           nextLine.includes('아군 피해량 강화 효과가')) {
                    // 현재 줄에 특정 키워드가 있는지 확인
                    if (currentLine.includes('공격 적중 시') || 
                        currentLine.includes('파티 효과로 보호 효과가 적용된') ||
                        currentLine.includes('파티 효과로 보호 효과(보호막')) {
                      isDualEffect = true;
                    } else {
                      // 다른 경우는 단일 효과
                    }
                  }
                  // 8. "해당 효과는 한 파티 당 하나만 적용되며" 키워드가 있는 경우 (보호막 딜증 등)
                  else if (nextLine.includes('해당 효과는 한 파티 당 하나만 적용되며')) {
                    // 보호막 관련 효과인지 확인
                    if (currentLine.includes('파티 효과로 보호 효과')) {
                      isDualEffect = true;
                    }
                  }
                  
                  if (isDualEffect) {
                    effectText = `${currentLine} ${nextLine}`;
                    j++; // 다음 줄도 처리했으므로 건너뛰기
                  } else {
                    effectText = currentLine;
                  }
                }
              } else {
                effectText = currentLine;
              }
              
              const classification = classifyBraceletEffect(effectText, itemGrade);
              
              if (classification.shouldShow) {
                const effectData = {
                  text: effectText,
                  category: classification.category,
                  grade: classification.grade,
                  fullText: effectContent
                };
                
                if (classification.isBaseStat) {
                  baseStats.push(effectData);
                } else {
                  specialEffects.push(effectData);
                }
              }
            }
          }
        }
      }
    }
    
    return { baseStats, specialEffects };
  } catch (error) {
    console.error('팔찌 효과 파싱 에러:', error);
  }
  
  return { baseStats: [], specialEffects: [] };
};